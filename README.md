# Keepix Smart Node Plugin

## Pre-requies

Install Dotnet  
`dotnet version 7.0.402`  
- Linux: (source: https://learn.microsoft.com/en-us/dotnet/core/install/linux-scripted-manual)  
`wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh`  
`chmod +x ./dotnet-install.sh`  
`./dotnet-install.sh --version 7.0.402`  
`./dotnet-install.sh --version 7.0.402 --runtime aspnetcore`  
`./dotnet-install.sh --channel 7.0.402`  
`export DOTNET_ROOT=$HOME/.dotnet`  
`export PATH=$PATH:$DOTNET_ROOT:$DOTNET_ROOT/tools`  
- Macos: (source: https://github.com/isen-ng/homebrew-dotnet-sdk-versions)  
`brew tap isen-ng/dotnet-sdk-versions`  
`brew install --cask 7.0.402`  
see your installed versions: `dotnet --list-sdks`   
- Windows:  
Install it via "Visual Studio" and if necessary change the version 7.? on globals.json  

Install nodejs v18  
`curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash`  
`nvm install v18`  
`nvm use v18`  

# Install

`npm install`  
`dotnet restore`  

## Run

`npm run start`  

Go on http://localhost:3000
Also an api mock of keepix-server are available on http://localhost:2000/plugins/Keepix.SmartNodePlugin/status like routes where you can see on keepix-server.  

## Publish Release

public/package.json are used for publish the build of the plugin.  
  
The plugin is loaded by the keepix-server.
Warn attention to set the path of the plugin correctly on the package.json at the build step like this PUBLIC_URL=/plugins/Keepix.SmartNodePlugin/view

`npm run build`  
`npm run publish`  

## Documentation Section

### Plugin Dotnet

The plugin using the Keepix.PluginSystem library who override the STDout and STDerr and format an result like this:  
`{ "jsonResult": "{ \"x\": \"x\" }", "stdOut": "logs" }`  

The plugin using the [KeepixPluginFn("function-name")] annotation for exposing functions.

Manually CLI Input example [running install function]:
`./Plugin.SmartNodePlugin '{ "key": "install", "data1": "a", "data2": "b" }'`  
`{ "jsonResult": true, "stdOut": "Checking docker is installed ...\n Check Ok..\nInstallation Of the dockers ...\nSuccessfully installed!" }`  

Manually CLI Output example [running install function]:
`./Plugin.SmartNodePlugin '{ "key": "status" }'`  
`{ "jsonResult": "{ \"status\": \"RUNNING\" }", "stdOut": "Checking on docker ...\n Check Ok..\nReturn result" }`  

Example of queries for running from the front-end one function on the debug server (Runned at the npm run start moment):  
  
```bash
GET http://localhost:2000/plugins/Keepix.SmartNodePlugin/status  
Result: { "result": "{ \"status\": \"XXX\" }", "stdOut": "..." }
```  

```bash
POST http://localhost:2000/plugins/Keepix.SmartNodePlugin/install?async=false  
Body: { "key": "install", "data1": "a", "data2": "b" }  
Result: { "result": true, "stdOut": "..." }
```  
  
```bash
POST http://localhost:2000/plugins/Keepix.SmartNodePlugin/install?async=true  
Body: { "key": "install", "data1": "a", "data2": "b" }  
Result: { "taskId": "Keepix.SmartNodePlugin-install" }
```  

```bash
GET http://localhost:2000/plugins/Keepix.SmartNodePlugin/watch/task/Keepix.SmartNodePlugin-install  
Result: { "status": "RUNNING" }
Result: { "status": "ERROR", "description": "" }
Result: { "status": "FINISHED", "description": "" }
```  

[Listing of Implemented functions (function generated by the Keepix.PluginSystem)]  
```bash
GET http://localhost:2000/plugins/Keepix.SmartNodePlugin/exposed-functions
Result: ["install", "uninstall", ...]
```  


### Plugin LifeCycle Required Exposed Functions

Install (return boolean of success) function called at the installation time  
```bash
                                 [KeepixPluginFn("install")]
public static async Task<bool> OnInstall(InstallInput input)
{
    ...
    return true;
}
```  

Uninstall (return boolean of success) function called at the uninstallation time  
```bash
               [KeepixPluginFn("uninstall")]
public static async Task<bool> OnUninstall()
{
    ...
    return true;
}
```  

Installed (return boolean true if plugin is installed else false) function called at any time for display the plugin if the npm package exists 
```bash
               [KeepixPluginFn("installed")]
public static async Task<bool> OnInstalled()
{
    stateManager = PluginStateManager.GetStateManager();
    return stateManager.Installed;
}
```  
  
Example of exposed function who return data:  
```bash
               [KeepixPluginFn("x")]
public static async Task<string> OnX()
{
    ...
    return JsonConvert.SerializeObject(new {
        IsSynced = StateService.IsNodeSynced(),
        executionSyncProgress,
        consensusSyncProgress
    });
}
```  

### Plugin Front-end

The plugin need a front-end static code in the final build directory index.html file  
Here we are using a React framework  
The Front-end application will be loaded by the Keepix with an iframe at the following endpoint url:  
  
`http|https://hostname/plugins/Keepix.SmartNodePlugin/view`  

Here the plugin Name is 'Keepix.SmartNodePlugin' but in function of your plugin name change this line in the package.json:  
  
`PUBLIC_URL=/plugins/Keepix.SmartNodePlugin/view react-app-rewired build` 

And in the src-front/constants.ts:  
  
`export const PLUGIN_NAME = 'Keepix.SmartNodePlugin';`  
  
### Plugin Dev Api from Front-end dev
  
For developping locally your plugin on the config-overrides.js you can see a  
express.js running on 0.0.0.0:2000 is a simulation server copying routes of the real keepix server.  

`GET /plugins/nameOfThePlugin/:key`  
`POST /plugins/nameOfThePlugin/:key`  
`GET /plugins/nameOfThePlugin/watch/tasks/:taskId`  

Enjoy now you are ready for build a new Keepix plugin, Nice Coding!  
Ps: when you are ready for publishing you Plugin go to the Publish directory section ->   

## Publish Directory
  
Example of build directory for the plugin Keepix.SmartNodePlugin  
  
```bash
/buid  
  /dist  
    /linux-arm64  
      Keepix.SmartNodePlugin  
    /linux-x64  
      Keepix.SmartNodePlugin  
    /win-x64  
      Keepix.SmartNodePlugin  
    /win-arm64  
      Keepix.SmartNodePlugin  
    /osx-x64  
      Keepix.SmartNodePlugin  
    /osx-arm64  
      Keepix.SmartNodePlugin  
  index.html
  package.json
```
  
When you are ready you can npm run publish the build directory.  
After this step you need to creating a pull request on the https://github.com/Keepix-labs/Keepix.Plugins repository for adding your plugin on the official list of plugin and just waiting 10 minutes on the keepix-server for see your plugin on the store.  

## Contributors

Jeremy Guyet  
Frederic Marinho  
